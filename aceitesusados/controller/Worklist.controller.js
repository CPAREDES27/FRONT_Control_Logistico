sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/m/MessageBox","sap/ui/core/util/ExportTypeCSV","sap/ui/core/util/Export","sap/m/MessageToast"],function(e,t,a,o,i,n,r,s,l,c){"use strict";const d="https://cf-nodejs-qas.cfapps.us10.hana.ondemand.com/api/";var u=new sap.m.BusyDialog;var g=null;var h=false;var p="";return e.extend("com.tasa.aceitesusados.controller.Worklist",{formatter:a,onInit:async function(){try{await this.loadCombos();this.planta=await this.llenarPlanta(this.centro);console.log(this.planta)}catch(e){r.error("Ocurrió un error en la carga, actualice el navegador")}},loadCombos:async function(){u.open();var e=null;var t=null;var a=null;var o=null;var i=null;var n=null;var r={dominios:[{domname:"ZD_FLESRNV",status:"A"},{domname:"ZINPRP",status:"A"},{domname:"ALMACEN",status:"A"},{domname:"CENTRO",status:"A"},{domname:"MATERIAL",status:"A"},{domname:"TIPOMATERIAL",status:"A"}]};await fetch(`${d}dominios/Listar`,{method:"POST",body:JSON.stringify(r)}).then(e=>e.json()).then(o=>{var r=o;console.log(r);e=o.data.find(e=>e.dominio=="ZD_FLESRNV").data;t=o.data.find(e=>e.dominio=="ZINPRP").data;a=o.data.find(e=>e.dominio=="ALMACEN").data;i=o.data.find(e=>e.dominio=="MATERIAL").data;n=o.data.find(e=>e.dominio=="TIPOMATERIAL").data;this.getModel("Estado").setProperty("/ZD_FLESRNV",e);this.getModel("Propiedad").setProperty("/ZINPRP",t);this.getModel("Almacen").setProperty("/ALMACEN",a);this.getModel("Material").setProperty("/MATERIAL",i);this.getModel("TipoMaterial").setProperty("/TIPOMATERIAL",n);this.centro=o.data.find(e=>e.dominio=="CENTRO").data[0].id;u.close()}).catch(e=>console.log(e))},_onOpenDialogEmbarcacion:function(e){this.getView().getModel("Embarcacion").setProperty("/listaEmbarcacion","");if(e==="hola"){this.codEmbarca=true}this._getDialogEmbarcacion().open()},_onCloseDialogEmbarcacion:function(){this._getDialogEmbarcacion().close()},_getDialogEmbarcacion:function(){if(!this._oDialogEmbarcacion){this._oDialogEmbarcacion=sap.ui.xmlfragment("com.tasa.aceitesusados.view.DlgEmbarcacion",this.getView().getController());this.getView().addDependent(this._oDialogEmbarcacion)}sap.ui.getCore().byId("idEmbarcacion").setValue("");sap.ui.getCore().byId("idEmbarcacionDesc").setValue("");sap.ui.getCore().byId("idMatricula").setValue("");sap.ui.getCore().byId("idRuc").setValue("");sap.ui.getCore().byId("idArmador").setValue("");sap.ui.getCore().byId("titleEmbarca").setText("Lista de registros: ");return this._oDialogEmbarcacion},buscar:function(e){var t=e.mParameters.listItem.oBindingContexts.Embarcacion.sPath.split("/")[2];var a=this.getView().getModel("Embarcacion").oData.listaEmbarcacion[t].CDEMB;var o=this.getView().getModel("Embarcacion").oData.listaEmbarcacion[t].NMEMB;if(this.codEmbarca){sap.ui.getCore().byId("idEmbarcacionNew").setValue(a);sap.ui.getCore().byId("txtEmbarcaNew").setText(o)}else{this.byId("idEmbarcacion2").setValue(a);this.byId("txtEmbarca").setText(o)}this._onCloseDialogEmbarcacion()},listaEmbarcacion:function(){u.open();console.log("BusquedaEmbarca");var e=sap.ui.getCore().byId("idEmbarcacion").getValue();var t=sap.ui.getCore().byId("idEmbarcacionDesc").getValue();var a=sap.ui.getCore().byId("idMatricula").getValue();var o=sap.ui.getCore().byId("idRuc").getValue();var i=sap.ui.getCore().byId("idArmador").getValue();var n=sap.ui.getCore().byId("idPropiedad").getSelectedKey();var r=[];var s=[];r.push({cantidad:"20",control:"COMBOBOX",key:"ESEMB",valueHigh:"",valueLow:"O"});if(e){r.push({cantidad:"20",control:"INPUT",key:"CDEMB",valueHigh:"",valueLow:e})}if(t){r.push({cantidad:"20",control:"INPUT",key:"NMEMB",valueHigh:"",valueLow:t})}if(a){r.push({cantidad:"20",control:"INPUT",key:"MREMB",valueHigh:"",valueLow:a})}if(n){r.push({cantidad:"20",control:"COMBOBOX",key:"INPRP",valueHigh:"",valueLow:n})}if(o){s.push({cantidad:"20",control:"INPUT",key:"STCD1",valueHigh:"",valueLow:o})}if(i){s.push({cantidad:"20",control:"INPUT",key:"NAME1",valueHigh:"",valueLow:i})}var l={option:[],option2:[],options:r,options2:s,p_user:"BUSQEMB"};console.log(l);fetch(`${d}embarcacion/ConsultarEmbarcacion/`,{method:"POST",body:JSON.stringify(l)}).then(e=>e.json()).then(e=>{console.log(e);var t=e.data;console.log(t);console.log(this.getView().getModel("Embarcacion").setProperty("/listaEmbarcacion",t));sap.ui.getCore().byId("titleEmbarca").setText("Lista de registros: "+t.length);if(t.length<=0){sap.ui.getCore().byId("titleEmbarca").setText("Lista de registros: No se encontraron resultados")}u.close()}).catch(e=>console.log(e))},onBusqueda:function(){u.open();var e=this.byId("idAlmacen").getSelectedKey();var t=this.byId("idEmbarcacion2").getValue();var a=this.byId("idEstado").getSelectedKey();var o=this.byId("idReserva").getValue();var i=this.byId("idFecha").mProperties.dateValue;var n=this.byId("idFecha").mProperties.secondDateValue;console.log(this.byId("idFecha"));var s="";var l=true;if(!this.byId("idFecha").mProperties.dateValue){s+="Debe ingresar una fecha de reserva";u.close();l=false}if(!l){r.error(s);return false}var c=new Date(i);var g;var h;g=c.getMonth()+1;h=c.getDate();if(g<10){g=this.zeroFill(g,2)}if(h<10){h=this.zeroFill(h,2)}var p=c.getFullYear()+""+g+""+h;var m=new Date(n);var v;var b;v=m.getMonth()+1;b=m.getDate();if(v<10){v=this.zeroFill(v,2)}if(b<10){b=this.zeroFill(b,2)}var f=m.getFullYear()+""+v+""+b;console.log(p);console.log(f);var N={fieldsEt_mensj:[],fieldsT_rnv:[],fieldsT_rpn:[],ip_cdalm:e,ip_cdemb:t,ip_esrnv:a,ip_fhrnvf:f,ip_fhrnvi:p,ip_nrrnv:o,ip_tope:"FR"};console.log(N);fetch(`${d}aceitesusados/Listar`,{method:"POST",body:JSON.stringify(N)}).then(e=>e.json()).then(e=>{console.log(e.t_rpn);this.getView().getModel("Aceite").setProperty("/listaAceite",e.t_rpn);u.close()}).catch(e=>console.log(e))},zeroFill:function(e,t){t-=e.toString().length;if(t>0){return new Array(t+(/\./.test(e)?2:1)).join("0")+e}return e+""},onDataExport:function(){var e=new l({exportType:new s({separatorChar:";",charset:"utf-8"}),models:this.getView().getModel("Aceite"),rows:{path:""},rows:{path:"/listaAceite"},columns:[{name:"Reserva",template:{content:"{NRRNV}"}},{name:"Embarcación",template:{content:"{NMEMB}"}},{name:"Material",template:{content:"{CDSUM}"}},{name:"Almacén",template:{content:"{CDALM}"}},{name:"Fecha de reserva",template:{content:"{FHCRN}"}},{name:"Total peso Kg",template:{content:"{CNSUM}"}},{name:"Cant. galones",template:{content:"{NRTGA}"}},{name:"UM",template:{content:"{MSEHL}"}},{name:"Estado",template:{content:"{ESRNV}"}}]});e.saveFile("Politica de Precios").catch(function(e){r.error("Error when downloading data. ..."+e)}).then(function(){e.destroy()})},filterGlobally:function(e){var t=e.getParameter("query");this._oGlobalFilter=null;if(t){this._oGlobalFilter=new o([new o("NRRNV",i.Contains,t),new o("NMEMB",i.Contains,t),new o("CDSUM",i.Contains,t),new o("CDALM",i.Contains,t),new o("FHCRN",i.Contains,t),new o("MSEHL",i.Contains,t),new o("ESRNV",i.Contains,t)],false)}this._filter()},_filter:function(){var e=null;if(this._oGlobalFilter&&this._oPriceFilter){e=new o([this._oGlobalFilter,this._oPriceFilter],true)}else if(this._oGlobalFilter){e=this._oGlobalFilter}else if(this._oPriceFilter){e=this._oPriceFilter}this.byId("table").getBinding().filter(e,"Application")},onDetail:function(e){var t=e.getSource().getBindingContext("Aceite").getPath().split("/")[2];console.log(t);console.log(this.getView().bindElement({path:"Aceite>/listaAceite/"+t}));console.log(this.getView().getModel("Aceite").oData.listaAceite[t]);this._onOpenDialogAceite()},_openNuevoAceite:function(){this._getNuevoAceite().open();this.onLimpiarNuevo()},_onCloseNuevoAceite:function(){this._getNuevoAceite().close()},_getNuevoAceite:function(){if(!this._oNuevoAceite){this._oNuevoAceite=sap.ui.xmlfragment("com.tasa.aceitesusados.view.DlgNuevoAceite",this.getView().getController());this.getView().addDependent(this._oNuevoAceite);sap.ui.getCore().byId("idCentroNew").setValue(this.centro)}return this._oNuevoAceite},_onOpenDialogAceite:function(){this._getDialogAceite().open()},_onCloseDialogAceite:function(){this._getDialogAceite().close()},_getDialogAceite:function(){if(!this._oDialogAceite){this._oDialogAceite=sap.ui.xmlfragment("com.tasa.aceitesusados.view.DlgDetalleAceite",this.getView().getController());this.getView().addDependent(this._oDialogAceite);sap.ui.getCore().byId("idCentro").setValue(this.centro)}return this._oDialogAceite},onLimpiar:function(){this.byId("idReserva").setValue("");this.byId("idEstado").setValue("");this.byId("idAlmacen").setValue("");this.byId("idEmbarcacion2").setValue("");this.byId("idFecha").setValue("");this.byId("txtEmbarca").setText("")},castFecha:function(e){if(e==="null"||e===""){return""}var t=e.split("/");console.log(t);console.log(t[2]+t[1]+t[0]);return t[2]+t[1]+t[0]},castHora:function(e){var t=e.split(":");console.log(t);console.log(t[2]+t[1]+t[0]);return t[2]+t[1]+t[0]},onAnular:function(){var e=this.byId("table").getSelectedIndices();var t;console.log(e);var a=this.getView().byId("table").getModel("Aceite").oData.listaAceite;for(var o=0;o<e.length;o++){if(a[o].ESRNV==="A"){r.error("No se puede anular un registro con estado Anulado");return false}}console.log(a);var i=[];var t=[];r.warning("Desea anular el registro?",{icon:r.Icon.WARNING,title:"Anular",actions:[r.Action.YES,r.Action.NO],emphasizedAction:r.Action.YES,onClose:function(o){if(o=="YES"){for(var n=0;n<e.length;n++){for(var r=0;r<a.length;r++){if(r==e[n]){i={atcrn:a[r].ATCRN,atmfn:a[r].ATMFN,cdalm:a[r].CDALM,cdemb:a[r].CDEMB,cdpta:a[r].CDPTA,cdsum:a[r].CDSUM,cdumd:a[r].CDUMD,cnbar:a[r].CNBAR,cnsum:a[r].CNSUM,demat:a[r].DEMAT,dsest:a[r].DSEST,dswks:a[r].DSWKS,esrnv:a[r].ESRNV,fhcrn:this.castFecha(a[r].FHCRN),fhmfn:this.castFecha(a[r].FHMFN),fhrnv:this.castFecha(a[r].FHRNV),hrcrn:a[r].HRCRN,hrmfn:a[r].HRMFN,lgobe:a[r].LGOBE,mandt:a[r].MANDT,msehl:a[r].MSEHL,nmemb:a[r].NMEMB,nrgrm:a[r].NRGRM,nrpos:a[r].NRPOS,nrrnv:a[r].NRRNV,nrtga:a[r].NRTGA,nrtkp:a[r].NRTKP}}}t.push(i)}this.anularPrecio(t);u.close()}else{u.close()}}.bind(this)})},anularPrecio:function(e){console.log(e);u.open();var t={fhrnv:"",fieldsEt_mensj:[],fieldsT_rnv:[],fieldsT_rpn:[],ip_cdalm:"",ip_cdemb:"",ip_esrnv:"",ip_fhrnvf:"",ip_fhrnvi:"",ip_nrrnv:"",ip_tope:"",t_rpn:e};console.log(t);fetch(`${d}aceitesusados/Anular`,{method:"POST",body:JSON.stringify(t)}).then(e=>e.json()).then(t=>{console.log(t.length);var a=t;console.log(a);var o="";for(var i=0;i<e.length;i++){o+="Reserva "+e[i].nrrnv+" borrada\n"}r.success(o);this.onBusqueda();u.close()}).catch(e=>r.error("El servicio no está disponible"))},onNuevo:function(){this._openNuevoAceite()},onLimpiarNuevo:function(){sap.ui.getCore().byId("idFechaReservaNew").setValue("");sap.ui.getCore().byId("idEmbarcacionNew").setValue("");sap.ui.getCore().byId("idMaterialNew").setValue("");sap.ui.getCore().byId("idAlmacenNew").setValue("");sap.ui.getCore().byId("idGalonesNew").setValue("");sap.ui.getCore().byId("idBarrilesNew").setValue("");sap.ui.getCore().byId("idTipoMaterialNew").setValue("");sap.ui.getCore().byId("idNroTicketNew").setValue("");sap.ui.getCore().byId("idRemisionNew").setValue("");sap.ui.getCore().byId("idKilosNew").setValue("");sap.ui.getCore().byId("txtEmbarcaNew").setText("")},onGuardar:function(){u.open();var e=sap.ui.getCore().byId("idFechaReservaNew").getValue();var t=sap.ui.getCore().byId("idEmbarcacionNew").getValue();var a=sap.ui.getCore().byId("idMaterialNew").getSelectedKey();var o=sap.ui.getCore().byId("idCentroNew").getValue();var i=sap.ui.getCore().byId("idAlmacenNew").getSelectedKey();var n=sap.ui.getCore().byId("idGalonesNew").getValue();var s=sap.ui.getCore().byId("idBarrilesNew").getValue();var l=sap.ui.getCore().byId("idTipoMaterialNew").getSelectedKey();var c=sap.ui.getCore().byId("idNroTicketNew").getValue();var g=sap.ui.getCore().byId("idRemisionNew").getValue();var h=sap.ui.getCore().byId("idKilosNew").getValue();c=this.zeroFill(c,10);console.log(e);console.log(t);console.log(a);console.log(o);console.log(i);console.log(n);console.log(s);console.log(l);console.log(c);console.log(g);console.log(h);var p={fhrnv:e,fieldsEt_mensj:[],fieldsT_rnv:[],fieldsT_rpn:[],ip_cdalm:"",ip_cdemb:"",ip_esrnv:"",ip_fhrnvf:"",ip_fhrnvi:"",ip_nrrnv:"",ip_tope:"NR",t_rpn:[{atcrn:"FGARCIA",atmfn:"",cdalm:i,cdemb:t,cdpta:this.planta,cdsum:a,cdumd:"",cnbar:s,cnsum:h,demat:l,dsest:"",dswks:"",esrnv:"",fhcrn:"",fhmfn:"",fhrnv:e,hrcrn:"000000",hrmfn:"000000",lgobe:"",mandt:"",msehl:"",nmemb:"",nrgrm:g,nrpos:"0000",nrrnv:"0000000000",nrtga:n,nrtkp:c}]};console.log(p);fetch(`${d}aceitesusados/Nuevo`,{method:"POST",body:JSON.stringify(p)}).then(e=>e.json()).then(e=>{console.log(e);if(e&&e.ep_nrrnv!="0000000000"){r.warning(e.et_mensj,{icon:r.Icon.SUCCESS,title:"Registro satisfactorio",actions:[r.Action.OK],emphasizedAction:r.Action.YES,onClose:function(e){if(e=="OK"){this._onCloseNuevoAceite()}}.bind(this)})}else{r.error(e.et_mensj)}u.close()}).catch(e=>r.error("El servicio no está disponible"))},llenarPlanta:async function(e){console.log(e);u.open();var t="";var a={delimitador:"|",fields:["CDPTA"],no_data:"",option:[],options:[{cantidad:"10",control:"INPUT",key:"WERKS",valueHigh:"",valueLow:e}],order:"",p_user:"FGARCIA",rowcount:0,rowskips:0,tabla:"ZFLPTA"};await fetch(`${d}General/Read_Table/`,{method:"POST",body:JSON.stringify(a)}).then(e=>e.json()).then(e=>{t=e.data[0].CDPTA;u.close()}).catch(e=>{r.error("Ocurrió un error en la carga, favor de actualizar");u.close()});return t}})});