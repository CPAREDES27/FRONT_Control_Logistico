sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","./utilities","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/ui/core/BusyIndicator","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/export/library","sap/ui/export/Spreadsheet"],function(t,e,o,n,a,i,s,r,l,u){"use strict";var c=l.EdmType;return t.extend("com.tasa.tolvas.registrotolvas.controller.Main",{dataTableKeys:["NRDES","WERKS","TICKE","CDEMB","NMEMB","MREMB","CPPMS","FIDES","HIDES","FFDES","HFDES","CNPDS"],handleRouteMatched:function(t){var e="App60f18d59421c8929c54cd9bf";var o={};if(t.mParameters.data.context){this.sContext=t.mParameters.data.context}else{if(this.getOwnerComponent().getComponentData()){var n=function(t){if(Object.keys(t).length!==0){for(var e in t){if(e!=="sourcePrototype"&&e.includes("Set")){return e+"("+t[e][0]+")"}}}};this.sContext=n(this.getOwnerComponent().getComponentData().startupParameters)}}var a;if(this.sContext){a={path:"/"+this.sContext,parameters:o};this.getView().bindObject(a)}this.requestListaRegistroTolvas()},requestListaRegistroTolvas:function(){i.show(0);let t="",e=this.getView(),n=this.getOwnerComponent().getModel("FilterModel"),s=[],r=[],l=n.getProperty("/CentroDescarga"),u=n.getProperty("/FechaInicioDescarga"),c=n.getProperty("/HoraInicioDescarga"),g=n.getProperty("/CantidadFilas"),h="";s=[];if(!o.isEmpty(l)){r.push({wa:`CDPTA LIKE '${l}'`})}if(!o.isEmpty(u)){r.push({wa:`FIDES LIKE '${u}'`})}if(!o.isEmpty(c)){r.push({wa:`HIDES LIKE '${c}'`})}o.getDataFromRegistroTolvas(r,s,g.toString()).then(n=>{console.log("Data: ",n);let l=n;let u=[];let c=[];l.forEach(t=>{if(c.findIndex(e=>e===t.CDPTA)===-1){c.push(t.CDPTA)}});t="ZFLPTA";s=["WERKS"];let p=[];c.forEach(e=>{r=[{control:"INPUT",key:"CDPTA",valueLow:e,valueHigh:"",Longitud:"10"}];p.push(o.getDataFromReadTable(t,r,s,h,g).then(t=>{u.push(t[0].WERKS)}))});let d=0;$.when.apply(undefined,p).then(t=>{let o=null;for(let t=0;t<l.length;t++){o=l[t];if(o.NRMAR>0){l.splice(t,1);t--}else{d=c.findIndex(t=>t===o.CDPTA);if(d!==-1){o.WERKS=u[d]}}}e.setModel(new a(l),"RegistroTolvasModel")});i.hide()})},_onInputValueHelpRequest:function(t){var e="BusquedaDeEmpresas";this.mDialogs=this.mDialogs||{};var o=this.mDialogs[e];if(!o){o=new BusquedaDeEmpresas(this.getView());this.mDialogs[e]=o;o.setRouter(this.oRouter)}var n=t.getSource().getBindingContext();o._oControl.setBindingContext(n);o.open()},_onButtonPress:function(t){var o=t.getSource().getBindingContext();return new Promise(function(t){this.doNavigate("EdicionRegistroTolva",o,t,"")}.bind(this)).catch(function(t){if(t!==undefined){e.error(t.message)}})},_onButtonPress1:function(t){var o=t.getSource().getBindingContext("RegistroTolvasModel");return new Promise(function(t){this.doNavigate("EdicionRegistroTolva",o,t,"")}.bind(this)).catch(function(t){if(t!==undefined){e.error(t.message)}})},doNavigate:function(t,e,o,n){var a=e?e.getPath():null;var i=e?e.getModel():null;this.getOwnerComponent().getModel("passModel").setProperty("/data",i.getProperty(a));this.oRouter.navTo(t);if(typeof o==="function"){o()}},onInit:function(){this.oRouter=sap.ui.core.UIComponent.getRouterFor(this);this.oRouter.getTarget("TargetMain").attachDisplay(jQuery.proxy(this.handleRouteMatched,this));var t=this.getView();t.addEventDelegate({onBeforeShow:function(){if(sap.ui.Device.system.phone){var e=t.getContent()[0];if(e.getShowNavButton&&!e.getShowNavButton()){e.setShowNavButton(true);e.attachNavButtonPress(function(){this.oRouter.navTo("",{},true)}.bind(this))}}}.bind(this)});this.cargarInitData()},cargarInitData:function(){var t=this.getCurrentUser();var e=this.getView();var n=this.getOwnerComponent().getModel("CombosModel");o.obtenerCentros(t).then(t=>{console.log("Centros: ",t);n.setProperty("/Centros",t)});var a=["ZINPRP"];o.getDataFromDominios(a).then(t=>{console.log("IndProp: ",t);n.setProperty("/IndProp",t[0].data)})},filterGlobally:function(t){let e=t.getSource().getValue();const o=this.byId("tableData");const n=o.getBinding("rows");const a=n.oList;let i=[];this.dataTableKeys.forEach(t=>{const o=typeof a[0][t];let n=null;switch(o){case"string":n=r.Contains;break;case"number":n=r.EQ;break}const l=new s(t,n,e);i.push(l)});const l=new s({filters:i});n.filter(l,"Application")},createColumnConfig:function(){var t=[];const e=[];const o=this.byId("tableData");let n=o.getColumns();const a=o.getBinding("rows").oList;for(let t=0;t<n.length;t++){let o=n[t].getAggregation("template");if(o){let t=o.getId();let n=sap.ui.getCore().byId(t);let a=n.getText();e.push(a)}}e.splice(e.length-2,1);e.pop();const i=e.map((t,e)=>({column:t,key:this.dataTableKeys[e]}));i.forEach(e=>{const o=typeof a[0][e.key];let n={label:e.column,property:e.key};switch(o){case"number":n.type=c.Number;n.scale=0;break;case"string":n.type=c.String;n.wrap=true;break}t.push(n)});return t},exportarExcel:function(t){var e,o,n,a,i;if(!this._oTable){this._oTable=this.byId("tableData")}i=this._oTable;o=i.getBinding("rows");e=this.createColumnConfig();n={workbook:{columns:e,context:{sheetName:"CONSULTA DE DESCARGAS"}},dataSource:o,fileName:"Consulta de pesca descargada.xlsx",worker:false};a=new u(n);a.build().finally(function(){a.destroy()})},getCurrentUser:function(){return"FGARCIA"}})},true);